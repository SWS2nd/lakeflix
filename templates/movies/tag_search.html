<!-- templates/movies/tag_search.html -->
{% extends 'base.html' %}

{% block content %}

    <script type="text/javascript">
        // window.onloadë¡œ í™”ë©´ì´ ëª¨ë‘ ë¡œë“œë˜ê³  ë‚œ í›„ ì§„í–‰ë˜ë„ë¡ í•¨.

        // 1. í•´ë‹¹ id, class ì†ì„±ì„ ê°€ì§„ ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ê°€ì ¸ì™€ ì „ì²´ì— ì´ë²¤íŠ¸ ë¶™ì´ê¸°.
        // ë°•ìŠ¤, ì¥ë¥´ëª… ì–´ëŠê²ƒì„ í´ë¦­í•´ë„ í´ë¦­ ë˜ë„ë¡.
        // ë°˜ë³µì„ ì¤„ì¼ ìˆ˜ ìˆê³ , html íƒœê·¸ê°€ ê¹”ë”í•´ì§€ë©°, ê´€ë¦¬ê°€ ì‰¬ì›Œì§.
        // returnì´ ë°°ì—´ê°’ìœ¼ë¡œ ë°˜ë³µë¬¸ì„ ëŒë ¤ ì „ì²´ ì—˜ë¦¬ë¨¼íŠ¸ì— ì´ë²¤íŠ¸ë¥¼ ë¶™ì„.
        window.onload = function () {
            let lis = document.querySelectorAll("#genre-box .check-label");
            // console.log(lis)
            lis.forEach(function (el) {
                el.addEventListener("click", check_label_click, false)
            })
        }

        /*
        // 2. í•´ë‹¹ id ì†ì„±ì„ ê°€ì§„ ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ê°€ì ¸ì™€ ì´ë²¤íŠ¸ë¥¼ ë¶™ì´ê¸°.
        window.onload=function (){
            let element = document.getElementById("genre-box");
            console.log(element) // 1ê°œë§Œ ê²€ìƒ‰ë¨.
            element.addEventListener("click", check_label_click)
        }
        */

        /*
        // 3. í•´ë‹¹ class ì†ì„±ì„ ê°€ì§„ ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ê°€ì ¸ì™€ ì´ë²¤íŠ¸ë¥¼ ë¶™ì„.
        window.onload=function (){
            // returnì´ ë°°ì—´ê°’ìœ¼ë¡œ ë°˜ë³µë¬¸ì„ ëŒë ¤ ì „ì²´ ì—˜ë¦¬ë¨¼íŠ¸ì— ì´ë²¤íŠ¸ë¥¼ ë¶™ì„.
            let element = document.getElementsByClassName("check-label")
            // console.log(element)
            for(let i=0; i<element.length; i++){
                element[i].addEventListener("click", check_label_click, false)
            }
        }
        */

        // í´ë¦­ì‹œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜ì˜ ì¸ìˆ˜ë¡œ eventë¥¼ ë„£ì–´ì¤€ë‹¤.
        // í•´ë‹¹ ì¸ìˆ˜ë¡œ ì´ë²¤íŠ¸ì˜ ëŒ€ìƒ ìš”ì†Œë¥¼ ì•Œ ìˆ˜ ìˆê²Œ í•´ì¤€ë‹¤.
        function check_label_click(e) {
            // event.target : í˜„ì¬ ì´ë²¤íŠ¸ê°€ ë°œìƒí•œ ìš”ì†Œì˜ ì†ì„±ì„ ì–»ì„ ìˆ˜ ìˆìŒ.
            // event.targetê³¼ thisëŠ” DOM ê°ì²´ì´ê³ , jQuery ê°ì²´ê°€ ì•„ë‹ˆê¸° ë•Œë¬¸ì— jQuery ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤.
            // ê·¸ë ‡ë‹¤ë©´ ì–´ë–»ê²Œ jQuery ê°ì²´ë¡œ ìš”ì†Œë¥¼ ë°›ì„ ìˆ˜ ìˆì„ê¹Œ? $(event.target) ë˜ëŠ” $(this)ì™€ ê°™ì€ ì‘ì—…ì„ í•´ì£¼ë©´ ëœë‹¤.
            // console.log(e.currentTarget)
            // console.log($(this))

            // í´ë˜ìŠ¤ ì†ì„± ê°’ì— negativeê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ í•´ë‹¹ ìš”ì†Œë¥¼ ìˆ¨ê¸°ê³ , ì „ì „ ìš”ì†Œë¥¼ ë³´ì—¬ì¤Œ.
            if ($(e.currentTarget).attr('class').includes("negative")) {
                $(e.currentTarget).hide()
                $(e.currentTarget.previousElementSibling.previousElementSibling).show()
            }
            // ì•„ë‹ˆë©´, í•´ë‹¹ ìš”ì†Œë¥¼ ìˆ¨ê¸°ê³ , ë‹¤ìŒ ìš”ì†Œë¥¼ ë³´ì—¬ì¤Œ.
            else {
                $(e.currentTarget).hide()
                $(e.currentTarget.nextElementSibling).show()
            }

            // 1. í´ë¦­í•œ ìš”ì†Œì˜ ë„˜ê²¨ì¤„ movie_typeì„ ì •ì˜í•¨.(ë“œë¼ë§ˆ, ì•¡ì…˜, ë“±ë“±)
            let element = e.currentTarget
            let span = element.querySelector('span')
            let movie_type = span.innerText
            console.log(movie_type)

            // 2. í´ë¦­í•œ ìš”ì†Œì˜ í´ë˜ìŠ¤ ì†ì„± ê°’ì„ ë³´ì—¬ì¤Œ.(check-label common ê°™ì€)
            // console.log($(e.currentTarget).attr('class'))
            // í´ë¦­í•œ ìš”ì†Œì˜ ë‹¤ìŒ ìš”ì†Œ í´ë˜ìŠ¤ ì†ì„± ê°’
            let next_class_attr = $(e.currentTarget.nextElementSibling).attr('class')
            // ë‹¤ìŒ ìš”ì†Œì˜ í´ë˜ìŠ¤ ì†ì„± ê°’ì´ undefinedì¼ ê²½ìš° ì „ì „ í´ë˜ìŠ¤ ì†ì„± ê°’ìœ¼ë¡œ ë˜ëŒì•„ê°. ì˜ˆì™¸ì²˜ë¦¬.
            if (next_class_attr === undefined) {
                next_class_attr = $(e.currentTarget.previousElementSibling.previousElementSibling).attr('class')
            }
            console.log(next_class_attr)

            // 3. í´ë¦­í•œ ìš”ì†Œì˜ ë‹¤ìŒ ìš”ì†Œ ì†ì„± ê°’ì— í¬í•¨ëœ stringì— ë”°ë¼ ë„˜ê²¨ì¤„ í•„í„° ìƒíƒœê°’ì„ ì •ì˜í•¨.
            let filter_attr = ""
            if (next_class_attr.includes("active")) {
                filter_attr = "filter"
            } else if (next_class_attr.includes("negative")) {
                filter_attr = "exclude"
            } else if (next_class_attr.includes("common")) {
                filter_attr = "uncheck"
            }
            console.log(filter_attr)

            // ì˜ˆë¥¼ë“¤ì–´, í´ë˜ìŠ¤ commonì—ì„œ í´ë¦­ì‹œ, í´ë˜ìŠ¤ activeë¡œ ë°”ë€Œë©´ì„œ, í´ë˜ìŠ¤ active ì†ì„± ê°’ì´ ë„˜ì–´ê°€ì•¼ í•¨.
            // 4. í´ë¦­í•œ ì‹œì ì˜ í•´ë‹¹ ìš”ì†Œì˜ movie_typeê³¼ ë‹¤ìŒ í´ë˜ìŠ¤ ì†ì„± ê°’ì— ë”°ë¼ ì •ì˜í•œ ê°’ì„ ë„˜ê²¨ì£¼ë©´ ë  ê²ƒì´ë‹¤.
            $.ajax({
                type: "POST",
                url: "{% url 'movies:tag_search' %}",
                data: {'movie_type': movie_type, 'filter_attr': filter_attr, 'csrfmiddlewaretoken': '{{ csrf_token }}'},
                dataType: "json",

                // 5. ì˜ ë°›ì•„ì¡Œìœ¼ë©´, ë°›ì•„ì§„ ë‚´ìš©ìœ¼ë¡œ ì‘ì—….
                success: function (response) {
                    // alert("ì„±ê³µ!")
                    console.log(typeof (response), response)
                    console.log(response['movies'])

                    $('#media-count').empty()
                    $('#media-body').empty()

                    let rows = response['movies']
                    console.log(rows.length)
                    let temp_count = `<h4 class="media-count">ì´ ${rows.length}ê°œì˜ ì‘í’ˆì´ ê²€ìƒ‰ë˜ì—ˆì–´ìš”!</h4>`
                    $('#media-count').append(temp_count)
                    for(let i=0; i<rows.length; i++) {
                        let title_kor = rows[i]['title_kor']
                        let pk = rows[i]['id']
                        let poster = rows[i]['poster']
                        // console.log(title_kor, pk)
                        let temp_html = `<div class="movie_box" style="margin-right: 2%; width: 100%">
                                            <div class="movie_poster" style="overflow:auto; width: 100%">
                                                <a href="/movies/${pk}">
                                                    <img src="${poster}" alt="ìœ„ì˜ ì´ë¯¸ì§€ë¥¼ ëˆ„ë¥´ë©´ í•´ë‹¹ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™ë©ë‹ˆë‹¤."
                                                         style="width: 200px; height: 100%">
                                                </a>
                                            </div>
                                            <div class="movie_title" style="overflow:auto;">
                                                <h4 class="text-gray-200 text-3xl font-medium">
                                                    ${title_kor}
                                                </h4>
                                            </div>
                                        </div>`

                        $('#media-body').append(temp_html)
                    }
                },
                error: function (request, status, error) {
                    console.log(request, status, error)
                }
            })


            /*
            if($('.common').css('display') !== 'none'){
                console.log(e.currentTarget)
                $(e.currentTarget).hide()
                //$(this).hide()
                // console.log($(e.currentTarget.nextElementSibling))
                // ì„ íƒí•œ ë…¸ë“œì™€ ê°™ì€ ë ˆë²¨ì— ìˆëŠ” ë‹¤ìŒ(ì„ íƒí•œ ë…¸ë“œì˜ ë°”ë¡œ ë°‘) í˜•ì œ ë…¸ë“œì˜ ìš”ì†Œë¥¼ ë³´ì—¬ì¤Œ.
                $(e.currentTarget.nextElementSibling).show()
            }
            else if($('.active').css('display') !== 'none'){
                console.log(e.currentTarget)
                $(this).hide()
                $(e.currentTarget.nextElementSibling).show()
            }
            else if($('.negative').css('display') !== 'none'){
                console.log(e.currentTarget)
                $(this).hide()
                // ì„ íƒí•œ ë…¸ë“œì™€ ê°™ì€ ë ˆë²¨ì— ìˆëŠ” ì´ì „(ì„ íƒí•œ ë…¸ë“œì˜ ë°”ë¡œ ìœ„) í˜•ì œ ë…¸ë“œì˜ ìš”ì†Œë¥¼ ë³´ì—¬ì¤Œ.
                $(e.currentTarget.previousElementSibling.previousElementSibling).show()
            }
            */
        }
    </script>

    <div class="finder-desktop" style="display: flex;width: 100%;height: 100%">
        <!-- ì™¼ìª½ ì»¬ëŸ¼ : íƒœê·¸ í•„í„° -->
        <div class="sidebar-wrapper" style="border-right: 5px solid black;left: 0">
            <div class="filter">
                <h2 class="filter-title">Filter</h2>
                <h4 class="filter-sub-title">Movie Type</h4>
                <div class="filter-checkbox-body">
                    <fieldset>
                        <legend>ì¥ë¥´ë³„</legend>
                        {% for genre in genres %}
                            <div id="genre-box" class="genre-box">
                                <div class="check-label common" style="display: flex">
                                    <svg fill="currentColor" preserveAspectRatio="xMidYMid meet" height="1em"
                                         width="1em" viewBox="0 0 16 16" style="vertical-align:middle">
                                        <path fill="#FFF" fill-rule="evenodd" stroke="currentColor"
                                              d="M2 .5A1.5 1.5 0 0 0 .5 2v12A1.5 1.5 0 0 0 2 15.5h12a1.5 1.5 0 0 0 1.5-1.5V2A1.5 1.5 0 0 0 14 .5H2z"></path>
                                    </svg>
                                    <span class="text" style="margin-left: 5px">{{ genre.name }}</span>
                                </div>
                                <div class="check-label active" style="display: none">
                                    <svg fill="currentColor" preserveAspectRatio="xMidYMid meet" height="1em"
                                         width="1em" viewBox="0 0 16 16" style="vertical-align:middle">
                                        <g fill="none" fill-rule="evenodd">
                                            <rect width="15" height="15" x=".5" y=".5" fill="#FFF" stroke="currentColor"
                                                  rx="2"></rect>
                                            <path fill="currentColor" fill-rule="nonzero"
                                                  d="M6.335 11.807V12c-.23 0-.44-.088-.495-.222L3.18 8.75c-.266-.277-.226-.697.049-.984.273-.285.698-.24.986.059l2.123 2.453 5.48-6.062a.665.665 0 0 1 .98 0 .7.7 0 0 1 .005.98l-5.929 6.59a.745.745 0 0 1-.54.215v-.193z"></path>
                                        </g>
                                    </svg>
                                    <span class="text" style="margin-left: 5px">{{ genre.name }}</span>
                                </div>
                                <div class="check-label negative" style="display: none">
                                    <svg fill="currentColor" preserveAspectRatio="xMidYMid meet" height="1em"
                                         width="1em" viewBox="0 0 16 16" style="vertical-align:middle">
                                        <g fill="none" fill-rule="evenodd">
                                            <rect width="15" height="15" x=".5" y=".5" fill="#FFF" stroke="currentColor"
                                                  rx="2"></rect>
                                            <rect width="10" height="1.6" x="3" y="7" fill="currentColor"
                                                  rx=".8"></rect>
                                        </g>
                                    </svg>
                                    <span class="text" style="margin-left: 5px">{{ genre.name }}</span>
                                </div>
                            </div>
                            <p></p>
                        {% endfor %}
                    </fieldset>
                </div>
            </div>
        </div>
        <!-- ì˜¤ë¥¸ìª½ ì»¬ëŸ¼ : í•„í„°ë§ ëœ ì˜ìƒë“¤ -->
        <div id="main-contents" style="width:100%; height:100%;">
            <div class="recommend_section_wrapper" style="margin-left: 5%; margin-right: 5%; margin-bottom: 2%">
                <div style='margin-top:2rem;margin-bottom:2rem;'>
                    <h2 id="media-title" class="text-gray-200 text-3xl font-medium" style="margin-bottom: 1%">
                        ê²€ìƒ‰ëœ Movies ğŸ˜
                    </h2>
                    <h4 id="media-count" style="margin-bottom: 2%">ì´ {{ mov_cnt }}ê°œì˜ ì‘í’ˆì´ ê²€ìƒ‰ë˜ì—ˆì–´ìš”!</h4>
                    <div id="media-body" class='movie_line'
                         style="display:flex; width: 100%; height: 100%; overflow-x: hidden; overflow-y: visible;">
                        {% for movie in movies %}
                            <div class="movie_box" style="margin-right: 2%; width: 100%">
                                <div class="movie_poster" style="overflow:auto; width: 100%">
                                    <a href="/movies/{{ movie.pk }}">
                                        <img src="{{ movie.poster }}" alt="ìœ„ì˜ ì´ë¯¸ì§€ë¥¼ ëˆ„ë¥´ë©´ í•´ë‹¹ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™ë©ë‹ˆë‹¤."
                                             style="width: 200px; height: 100%">
                                    </a>
                                </div>
                                <div class="movie_title" style="overflow:auto;">
                                    <h4 class="text-gray-200 text-3xl font-medium">
                                        {{ movie.title_kor }}
                                    </h4>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}